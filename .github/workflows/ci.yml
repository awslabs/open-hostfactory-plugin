name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.11'
  AWS_DEFAULT_REGION: us-east-1
  AWS_ACCESS_KEY_ID: testing
  AWS_SECRET_ACCESS_KEY: testing
  ENVIRONMENT: testing
  TESTING: true

jobs:
  lint-and-security:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install uv
      uses: astral-sh/setup-uv@v1
      with:
        enable-cache: true
        cache-dependency-glob: "pyproject.toml"
    
    - name: Install dependencies with uv (faster)
      run: |
        # Use uv for faster dependency installation in CI
        uv pip install --system -e ".[dev]"
    
    - name: Run Black (code formatting)
      run: |
        python -m black --check src/ tests/
    
    - name: Run isort (import sorting)
      run: |
        python -m isort --check-only src/ tests/
    
    - name: Run flake8 (style guide)
      run: |
        python -m flake8 src/ tests/
    
    - name: Run mypy (type checking)
      run: |
        python -m mypy src/
    
    - name: Run pylint (code analysis)
      run: |
        python -m pylint src/
      continue-on-error: true  # Don't fail CI on pylint warnings
    
    - name: Run bandit (security linter)
      run: |
        python -m bandit -r src/ -f json -o bandit-report.json
        python -m bandit -r src/ -f txt
      continue-on-error: true
    
    - name: Run safety (dependency vulnerability check)
      run: |
        python -m safety check
      continue-on-error: true
    
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json

  architecture-compliance:
    name: Architecture Compliance
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt -r requirements-dev.txt
    
    - name: Run Architecture Quality Checks
      run: |
        echo "Running architecture compliance checks..."
        python scripts/check_file_sizes.py --warn-only || true
        python scripts/validate_cqrs.py --warn-only || true
        python scripts/check_architecture.py --warn-only || true
      continue-on-error: true

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt -r requirements-dev.txt
    
    - name: Run unit tests
      run: |
        python -m pytest tests/unit/ \
          -v \
          --tb=short \
          --cov=src \
          --cov-report=term-missing \
          --cov-report=xml:coverage-unit.xml \
          --cov-branch \
          --no-cov-on-fail \
          --durations=10 \
          --maxfail=5 \
          -m "unit and not slow" \
          --timeout=60 \
          --junitxml=junit-unit.xml
    
    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results-${{ matrix.python-version }}
        path: |
          junit-unit.xml
          coverage-unit.xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: matrix.python-version == '3.11'
      with:
        file: coverage-unit.xml
        flags: unit
        name: unit-tests

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint-and-security]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt -r requirements-dev.txt
    
    - name: Run integration tests
      run: |
        python -m pytest tests/integration/ \
          -v \
          --tb=short \
          --cov=src \
          --cov-report=term-missing \
          --cov-report=xml:coverage-integration.xml \
          --cov-branch \
          --no-cov-on-fail \
          --durations=10 \
          --maxfail=3 \
          -m "integration" \
          --timeout=300 \
          --junitxml=junit-integration.xml
    
    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          junit-integration.xml
          coverage-integration.xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: coverage-integration.xml
        flags: integration
        name: integration-tests

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt -r requirements-dev.txt
    
    - name: Run end-to-end tests
      run: |
        python -m pytest tests/e2e/ \
          -v \
          --tb=short \
          --durations=10 \
          --maxfail=2 \
          -m "e2e" \
          --timeout=600 \
          --junitxml=junit-e2e.xml
    
    - name: Upload e2e test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: junit-e2e.xml

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[perf]')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt -r requirements-dev.txt
    
    - name: Run performance tests
      run: |
        python -m pytest tests/ \
          -v \
          --tb=short \
          --durations=20 \
          -m "slow" \
          --timeout=600 \
          --junitxml=junit-performance.xml
    
    - name: Upload performance test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-test-results
        path: junit-performance.xml

  build-and-package:
    name: Build & Package
    runs-on: ubuntu-latest
    needs: [lint-and-security, unit-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build wheel setuptools
        pip install -r requirements.txt
    
    - name: Build package
      run: |
        python -m build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          dist/
          build/

  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt -r requirements-dev.txt
    
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        path: test-results/
    
    - name: Generate comprehensive test report
      run: |
        python -m pytest tests/ \
          --junitxml=test-results-combined.xml \
          --cov=src \
          --cov-report=xml:coverage-combined.xml \
          --cov-report=html:htmlcov \
          --tb=short \
          -q \
          --maxfail=1 \
          --timeout=60 \
          -m "not slow"
      continue-on-error: true
    
    - name: Upload comprehensive test report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: comprehensive-test-report
        path: |
          test-results-combined.xml
          coverage-combined.xml
          htmlcov/
    
    - name: Upload final coverage to Codecov
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: coverage-combined.xml
        flags: comprehensive
        name: comprehensive-tests

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [lint-and-security, unit-tests, integration-tests, e2e-tests, build-and-package]
    if: always()
    
    steps:
    - name: Notify success
      if: ${{ needs.lint-and-security.result == 'success' && needs.unit-tests.result == 'success' && needs.integration-tests.result == 'success' && needs.e2e-tests.result == 'success' }}
      run: |
        echo "ðŸŽ‰ All CI checks passed successfully!"
    
    - name: Notify failure
      if: ${{ needs.lint-and-security.result == 'failure' || needs.unit-tests.result == 'failure' || needs.integration-tests.result == 'failure' || needs.e2e-tests.result == 'failure' }}
      run: |
        echo "ðŸ’¥ Some CI checks failed!"
        exit 1
