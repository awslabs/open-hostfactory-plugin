{
  "Type": "maintain",
  "TargetCapacitySpecification": {
    "TotalTargetCapacity": "{{ requested_count }}",
    "DefaultTargetCapacityType": "on-demand",
    "TargetCapacityUnitType": "units"
  },
  "LaunchTemplateConfigs": [
    {
      "LaunchTemplateSpecification": {
        "LaunchTemplateId": "{{ launch_template_id }}",
        "Version": "{{ launch_template_version }}"
      },
      "Overrides": [
        {% for compute_config in gpu_configurations %}
        {
          "InstanceType": "{{ compute_config.instance_type }}",
          "SubnetId": "{{ compute_config.subnet_id }}",
          "AvailabilityZone": "{{ compute_config.availability_zone }}",
          "WeightedCapacity": "{{ compute_config.gpu_count }}",
          "Placement": {
            "GroupName": "{{ compute_config.placement_group }}",
            "Tenancy": "default"
          }
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    }
  ],
  "OnDemandOptions": {
    "AllocationStrategy": "lowest-price",
    "SingleInstanceType": false,
    "SingleAvailabilityZone": "{{ single_az_deployment | default(false) }}",
    "MinTargetCapacity": "{{ min_gpu_capacity | default(1) }}"
  },
  "ReplaceUnhealthyInstances": true,
  "TerminateInstancesWithExpiration": false,
  "TagSpecifications": [
    {
      "ResourceType": "fleet",
      "Tags": [
        {"Key": "Name", "Value": "gpu-cluster-{{ request_id }}"},
        {"Key": "RequestId", "Value": "{{ request_id }}"},
        {"Key": "TemplateId", "Value": "{{ template_id }}"},
        {"Key": "CreatedBy", "Value": "{{ package_name | default('open-hostfactory-plugin') }}"},
        {"Key": "WorkloadType", "Value": "{{ workload_type | default('machine-learning') }}"},
        {"Key": "GPUOptimized", "Value": "true"},
        {"Key": "HighPerformanceComputing", "Value": "true"},
        {"Key": "ClusterSize", "Value": "{{ requested_count }}"},
        {"Key": "TotalGPUs", "Value": "{{ total_gpu_count }}"},
        {"Key": "Framework", "Value": "{{ ml_framework | default('pytorch') }}"},
        {"Key": "CostCenter", "Value": "{{ cost_center | default('research') }}"},
        {"Key": "Project", "Value": "{{ project_name }}"}
      ]
    }
  ]
}
