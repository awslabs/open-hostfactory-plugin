{
  "Type": "maintain",
  "TargetCapacitySpecification": {
    "TotalTargetCapacity": "{{ requested_count }}",
    "OnDemandTargetCapacity": "{{ web_tier_capacity + app_tier_capacity }}",
    "SpotTargetCapacity": "{{ db_tier_capacity }}",
    "DefaultTargetCapacityType": "on-demand"
  },
  "LaunchTemplateConfigs": [
    {
      "LaunchTemplateSpecification": {
        "LaunchTemplateId": "{{ web_tier_launch_template_id }}",
        "Version": "{{ web_tier_launch_template_version }}"
      },
      "Overrides": [
        {% for subnet_id in public_subnet_ids %}
        {
          "InstanceType": "{{ web_tier_instance_type }}",
          "SubnetId": "{{ subnet_id }}",
          "WeightedCapacity": 1,
          "Priority": 1.0
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    },
    {
      "LaunchTemplateSpecification": {
        "LaunchTemplateId": "{{ app_tier_launch_template_id }}",
        "Version": "{{ app_tier_launch_template_version }}"
      },
      "Overrides": [
        {% for subnet_id in private_subnet_ids %}
        {
          "InstanceType": "{{ app_tier_instance_type }}",
          "SubnetId": "{{ subnet_id }}",
          "WeightedCapacity": 1,
          "Priority": 2.0
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    },
    {
      "LaunchTemplateSpecification": {
        "LaunchTemplateId": "{{ db_tier_launch_template_id }}",
        "Version": "{{ db_tier_launch_template_version }}"
      },
      "Overrides": [
        {% for subnet_id in database_subnet_ids %}
        {
          "InstanceType": "{{ db_tier_instance_type }}",
          "SubnetId": "{{ subnet_id }}",
          "WeightedCapacity": 1,
          "Priority": 3.0
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    }
  ],
  "OnDemandOptions": {
    "AllocationStrategy": "prioritized",
    "CapacityReservationOptions": {
      "UsageStrategy": "use-capacity-reservations-first"
    }
  },
  "SpotOptions": {
    "AllocationStrategy": "capacity-optimized-prioritized",
    "InstanceInterruptionBehavior": "terminate",
    "InstancePoolsToUseCount": 2,
    "MaintenanceStrategies": {
      "CapacityRebalance": {
        "ReplacementStrategy": "launch-before-terminate"
      }
    }
  },
  "ReplaceUnhealthyInstances": true,
  "TerminateInstancesWithExpiration": false,
  "TagSpecifications": [
    {
      "ResourceType": "fleet",
      "Tags": [
        {"Key": "Name", "Value": "multi-tier-fleet-{{ request_id }}"},
        {"Key": "RequestId", "Value": "{{ request_id }}"},
        {"Key": "TemplateId", "Value": "{{ template_id }}"},
        {"Key": "CreatedBy", "Value": "{{ package_name | default('open-hostfactory-plugin') }}"},
        {"Key": "Architecture", "Value": "multi-tier"},
        {"Key": "Environment", "Value": "{{ environment }}"},
        {"Key": "Application", "Value": "{{ application_name }}"},
        {"Key": "WebTierCapacity", "Value": "{{ web_tier_capacity }}"},
        {"Key": "AppTierCapacity", "Value": "{{ app_tier_capacity }}"},
        {"Key": "DbTierCapacity", "Value": "{{ db_tier_capacity }}"},
        {"Key": "CostOptimized", "Value": "true"}
      ]
    }
  ]
}
